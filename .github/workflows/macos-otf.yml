name: MacOS

on:
  push:
    branches:
      - '*'
    tags-ignore:
      - '*'
  pull_request:

jobs:
  raku:
    strategy:
      matrix:
        os:
          - macos-latest
        raku-version:
          - 'latest'
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: Raku/setup-raku@v1
        with:
          raku-version: ${{ matrix.raku-version }}

      - name: Install Dependencies
        shell: bash
        run: |
          set -euo pipefail

          echo "==> Installing GNU FreeFont (direct download, no Homebrew cask)"

          FREEFONT_TMP="${RUNNER_TEMP}/freefont"
          mkdir -p "${FREEFONT_TMP}"
          cd "${FREEFONT_TMP}"

          urls=(
            "https://ftp.gnu.org/gnu/freefont/freefont-otf-20120503.tar.gz"
            "https://ftpmirror.gnu.org/freefont/freefont-otf-20120503.tar.gz"
            "https://gnu.mirror.constant.com/freefont/freefont-otf-20120503.tar.gz"
            "https://mirrors.ibiblio.org/CTAN/fonts/gnu-freefont/freefont-otf-20120503.tar.gz"
            "https://mirrors.ctan.org/fonts/gnu-freefont/freefont-otf-20120503.tar.gz"
          )

          got_tar=0
          for u in "${urls[@]}"; do
            echo "  -> Trying $u"
            if curl -L --retry 5 --retry-delay 10 --fail "$u" -o freefont-otf-20120503.tar.gz; then
              got_tar=1
              echo "  -> Downloaded from $u"
              break
            fi
          done

          if [ "$got_tar" -ne 1 ]; then
            echo "ERROR: Could not download freefont-otf-20120503.tar.gz from any mirror" >&2
            exit 1
          fi

          echo "==> Extracting fonts"
          tar xzf freefont-otf-20120503.tar.gz

          FONT_DIR="${HOME}/Library/Fonts"
          mkdir -p "${FONT_DIR}"

          echo "==> Copying OTF fonts into ${FONT_DIR}"
          find . -maxdepth 5 -type f -name '*.otf' -print -exec cp {} "${FONT_DIR}/" \;

          echo "Installed fonts:"
          ls -1 "${FONT_DIR}" | grep -i free || true

          # Make the directory visible to your Raku module
          echo "FREEFONT_DIR=${FONT_DIR}" >> "${GITHUB_ENV}"

          # *** IMPORTANT: go back to project root before running zef ***
          cd "$GITHUB_WORKSPACE"

          # Raku deps
          zef install MacOS::NativeLib
          zef install --/test --deps-only .

      - name: Install
        run: zef install --debug .
